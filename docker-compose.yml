x-base-service: &base-service
    platform: "linux/amd64"

x-default-service: &default-service
    <<: *base-service
    env_file: .env
    entrypoint: "bash -c"
    command: "exit 0"

x-clickhouse-default-node: &clickhouse-default-node
    <<: *base-service
    image: clickhouse-default-node
    env_file: .env
    healthcheck:
        test: [ "CMD", "/scripts/wait-for-it.sh", "${CH_NODE_HOST_NAME}:${CH_NODE_PORT}" ]
        interval: 15s
        timeout: 15s
        retries: 5

x-clickhouse-default-node-keeper: &clickhouse-default-node-keeper
    <<: *clickhouse-default-node
    image: clickhouse-default-node-keeper


services:
    clickhouse-default-node:
        <<: *default-service
        build:
            context: .
            dockerfile: ./docker/clickhouse/node.Dockerfile
            args:
                - CH_SERVER_IMG_VER=${CH_SERVER_IMG_VER}
        image: clickhouse-default-node
        volumes:
            - ch_default_node_1:/var/lib/clickhouse

    clickhouse-default-node-keeper:
        <<: *default-service
        build:
            context: .
            dockerfile: ./docker/clickhouse/node-with-keeper.Dockerfile
            args:
                - CH_SERVER_IMG_VER=${CH_SERVER_IMG_VER}
        image: clickhouse-default-node-keeper
        volumes:
            - ch_default_node_2:/var/lib/clickhouse

    clickhouse-node1:
        <<: *clickhouse-default-node-keeper
        environment:
            CH_NODE_HOST_NAME: clickhouse-node1
            CH_NODE_REPLICA_NAME: clickhouse-node1
            CH_NODE_SHARD_ID: 01
            CH_KEEPER_SERVER_ID: 1

    clickhouse-node2:
        <<: *clickhouse-default-node-keeper
        environment:
            CH_NODE_HOST_NAME: clickhouse-node2
            CH_NODE_REPLICA_NAME: clickhouse-node2
            CH_NODE_SHARD_ID: 01
            CH_KEEPER_SERVER_ID: 2

    clickhouse-node3:
        <<: *clickhouse-default-node-keeper
        environment:
            CH_NODE_HOST_NAME: clickhouse-node3
            CH_NODE_REPLICA_NAME: clickhouse-node3
            CH_NODE_SHARD_ID: 02
            CH_KEEPER_SERVER_ID: 3

    clickhouse-node4:
        <<: *clickhouse-default-node
        environment:
            CH_NODE_HOST_NAME: clickhouse-node4
            CH_NODE_REPLICA_NAME: clickhouse-node4
            CH_NODE_SHARD_ID: 02

    clickhouse-initer:
        <<: *base-service
        build:
            context: .
            dockerfile: ./docker/clickhouse-initer/Dockerfile
        env_file: .env
        depends_on:
            clickhouse-node1:
                condition: service_healthy
            clickhouse-node2:
                condition: service_healthy
            clickhouse-node3:
                condition: service_healthy
            clickhouse-node4:
                condition: service_healthy

volumes:
    ch_default_node_1:
    ch_default_node_2:
