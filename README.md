# UGC-movies

UGC-movies - —Å–µ—Ä–≤–∏—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è [–û–Ω–ª–∞–π–Ω –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä–∞ "Movies"](https://github.com/xczdenis/movies).

–°–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ–≥—Ä–æ–º–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
–æ–Ω–ª–∞–π–Ω-–∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä–∞. –ù–∞–ø—Ä–∏–º–µ—Ä, –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≤–µ–¥–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–æ –≤—Ä–µ–º—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–∏–ª—å–º–∞. –¢–∞–∫–∂–µ —ç—Ç–æ –º–æ–≥—É—Ç –±—ã—Ç—å
–ª–∞–π–∫–∏, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ, –æ—Ü–µ–Ω–∫–∞ —Ñ–∏–ª—å–º–∞ –∏ —Ç.–¥. –ù–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ —ç—Ç–∏—Ö –¥–∞–Ω–Ω—ã—Ö –º–æ–∂–Ω–æ —Å—Ç—Ä–æ–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω—É—é
—Å–∏—Å—Ç–µ–º—É.

–ë–ª–∞–≥–æ–¥–∞—Ä—è [Kafka](https://kafka.apache.org/), —Å–µ—Ä–≤–∏—Å —Å–ø–æ—Å–æ–±–µ–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ–≥—Ä–æ–º–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤
—Å–µ–∫—É–Ω–¥—É. –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ [ClickHouse](https://clickhouse.tech/) - OLAP —Ö—Ä–∞–Ω–∏–ª–∏—â–µ, —ç—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
–≤—ã–ø–æ–ª–Ω—è—Ç—å —Å–ª–æ–∂–Ω—ã–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã. –î–∞–Ω–Ω—ã–µ –æ –ª–∞–π–∫–∞—Ö –∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–º —Ö—Ä–∞–Ω—è—Ç—Å—è –≤
[MongoDB](https://www.mongodb.com/), —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –±—ã—Å—Ç—Ä–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ –¥–∞–Ω–Ω—ã–º –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å
—Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ –±–µ–∑ –ø—Ä–µ–¥–µ–ª–∞.


## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

<ul>
<li>–†–∞–±–æ—Ç–∞–µ—Ç —Å <b>Python 3.11</b>;</li>
<li>–ü–æ–ª–Ω–æ—Å—Ç—å—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π;</li>
<li><b>ClickHouse –∫–ª–∞—Å—Ç–µ—Ä</b> - OLAP —Ö—Ä–∞–Ω–∏–ª–∏—â–µ. –õ–µ–≥–∫–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –∫–æ–Ω—Ñ–∏–≥ –∫–ª–∞—Å—Ç–µ—Ä–∞;</li>
<li><b>Kafka –∫–ª–∞—Å—Ç–µ—Ä</b> - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Ç–æ–∫–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö:</li>
<ul>
    <li><b>aiokafka</b> - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å kafka;</li>
    <li><b>schema_registry</b> - —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ö–µ–º kafka;</li>
    <li><b>kafka-ui</b> - –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∞ kafka;</li>
</ul>
<li><b>–ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π ETL</b> –ø—Ä–æ—Ü–µ—Å—Å –∏–∑ Kafka –≤ ClickHouse</li>
<li><b>MongoDB –∫–ª–∞—Å—Ç–µ—Ä</b> - –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—ã–π, –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—ã–π –∫–ª–∞—Å—Ç–µ—Ä –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –ª–∞–π–∫–∞—Ö –∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–º;</li>
<li><b>FastAPI</b> - –±—ã—Å—Ç—Ä—ã–π –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è API;</li>
<li><b>Nginx</b> - –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API;</li>
<li><b>Python –∏–Ω–∏—Ç–µ—Ä—ã</b> - python-–∫–æ–¥ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤—Å–µ—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤:</li>
<ul>
    <li>Clickhouse initer;</li>
    <li>Kafka initer;</li>
    <li>Mongo initer;</li>
</ul>
<li>–ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å <b>Docker</b>:</li>
<ul>
    <li>Docker-compose –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏;</li>
    <li>–¢–µ—Å—Ç—ã –≤ Docker;</li>
    <li>–¢–æ–Ω–∫–∏–µ –æ–±—Ä–∞–∑—ã, –±–ª–∞–≥–æ–¥–∞—Ä—è multi-stage —Å–±–æ—Ä–∫–µ;</li>
</ul>
<li><b>Makefile</b> - —É–¥–æ–±–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–æ–º–∞–Ω–¥ –ø—Ä–æ–µ–∫—Ç–∞;</li>
<li><b>Pre-commit hooks</b> - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º –¥–ª—è —Å–æ–±–ª—é–¥–µ–Ω–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏;</li>
<li><b>Conventional commits</b> - —Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è –Ω–∞–ø–∏—Å–∞–Ω–∏—è –∫–æ–º–º–∏—Ç–æ–≤;</li>
<li>–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ <b>SOLID –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤</b>.</li>
</ul>


## –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Å–µ—Ä–≤–∏—Å–∞

–°–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:
1. –§–∏–∫—Å–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏—è, –ø—Ä–æ–∏–∑–æ—à–µ–¥—à–µ–≥–æ –≤–æ –≤—Ä–µ–º—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–∏–ª—å–º–∞ (–Ω–∞—á–∞–ª–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞, –ø–∞—É–∑–∞, –ø–µ—Ä–µ–º–æ—Ç–∫–∞ –≤–ø–µ—Ä–µ–¥,
–Ω–∞–∑–∞–¥, –æ—Å—Ç–∞–Ω–æ–≤–∫–∞);
2. –§–∏–∫—Å–∞—Ü–∏—è —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —Ñ–∏–ª—å–º–∞;
3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–∏–ª—å–º–∞ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã;
4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å–º–∞ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∏–ª—å–º–æ–≤;
5. –û—Ü–µ–Ω–∫–∏ —Ñ–∏–ª—å–º–æ–≤.

–ü–æ–¥—Ä–æ–±–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é API –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ –∞–¥—Ä–µ—Å—É: [http://127.0.0.1:8000/api/v1/openapi/](http://127.0.0.1:8000/api/v1/openapi#/)
![openapi.png](docs/assets/img/openapi.png)


## –ß–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
–°–µ—Ä–≤–∏—Å –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤ —á–∏—Å—Ç–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã. –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –æ–ø–µ—Ä–∏—Ä—É–µ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è–º–∏ –∏ –æ—Ç–¥–µ–ª–µ–Ω–∞
–æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

–ù–∞–ø—Ä–∏–º–µ—Ä, —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º, –ø—Ä–æ—Ü–µ—Å—Å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –≤—Ä–µ–º–µ–Ω–∏, –ø–æ—Ç—Ä–∞—á–µ–Ω–Ω–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä
—Ñ–∏–ª—å–º–∞. –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∞ –Ω–∏–∂–µ:

![add_movie_viewing_uml.png](docs/assets/img/add_movie_viewing_uml.png)
![img.png](img.png)
–†–∞–∑–±–µ—Ä–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø—Ä–æ—Ü–µ—Å—Å–∞:
1. `Controller` - –µ–Ω–¥–ø–æ–∏–Ω—Ç, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—â–∏–π –∑–∞–ø—Ä–æ—Å –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞;
2. `MovieViewingService` - –≤—ã–ø–æ–ª–Ω—è–µ—Ç –±–∏–∑–Ω–µ—Å –ª–æ–≥–∏–∫—É;
3. `MovieViewingGateway` - —à–ª—é–∑ –¥–∞–Ω–Ω—ã—Ö. –≠—Ç–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—â–∏–π –º–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.
–í–µ—Å—å –∫–æ–¥ –Ω–∞ —è–∑—ã–∫–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–æ–ª–∂–µ–Ω –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –∑–¥–µ—Å—å;
4. `KafkaMovieViewingGateway` - –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —à–ª—é–∑–∞ `MovieViewingGateway` –¥–ª—è Kafka;
5. `DatabaseClient` - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—â–∏–π —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö. –ó–¥–µ—Å—å –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –º–µ—Ç–æ–¥ `execute`,
–∫–æ—Ç–æ—Ä—ã–π –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π –≤ —à–ª—é–∑–µ `MovieViewingGateway`;
6. `KafkaEventProducerClient` - –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ `DatabaseClient` –¥–ª—è Kafka;


```python
@router.post(
    "/movie-viewing",
    name=make_rout_name(NAMESPACE, "add_movie_viewing"),
    response_description="The movie viewing time added successfully",
)
async def add_movie_viewing(
    request_movie_viewing: MovieViewingRequest,
    service: MovieViewingService = Depends(get_movie_viewing_service),
) -> MovieViewing:
    """
    Add time spent watching a movie.
    """
    movie_viewing = MovieViewing(
        user=User(id=request_movie_viewing.user_id),
        movie=Movie(id=request_movie_viewing.movie_id),
        viewed_seconds=request_movie_viewing.viewed_seconds,
    )

    await service.add_movie_viewing(movie_viewing=movie_viewing)

    return movie_viewing
```

## Requirements

* Python 3.11+
* Docker version 23.0.5+
* Docker Compose version 2.17.3+


## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

–í—Å–µ –∫–æ–º–∞–Ω–¥—ã, –ø—Ä–∏–≤–µ–¥–µ–Ω–Ω—ã–µ –≤ –¥–∞–Ω–Ω–æ–º —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–µ, –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞, –µ—Å–ª–∏ –∏–Ω–æ–µ –Ω–µ
—É–∫–∞–∑–∞–Ω–æ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã.


### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π —Ñ–∞–π–ª—ã `.env` –∏ `.env.local` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞, –≤—ã–ø–æ–ª–Ω–∏–≤ –∫–æ–º–∞–Ω–¥—É:
```bash
make env
```
–ú–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã `env.template` –∏ `env.local.template`.


### –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞

üö® –£–±–µ–¥–∏—Å—å, —á—Ç–æ —É —Ç–µ–±—è —Å–≤–æ–±–æ–¥–Ω—ã –≤—Å–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ—Ä—Ç—ã:
1. –í—Å–µ –ø–æ—Ä—Ç—ã –≤ `.env.local`;
2. –í—Å–µ –ø–æ—Ä—Ç—ã —Ä–∞–∑–¥–µ–ª–∞ `Expose ports for clickhouse's nodes` –≤ `.env`;
3. –ü–æ—Ä—Ç `KAFKA_BROKER_EXPOSE_PORT` –≤ `.env`.

üö® –£–∫–∞–∂–∏ —Å–≤–æ—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –¥–ª—è docker –æ–±—Ä–∞–∑–æ–≤ –≤ `.env`. –ù–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è Mac –Ω–∞ M1 –≤–æ—Ç —Ç–∞–∫:
```bash
DOCKER_IMG_PLATFORM=linux/arm64
```

–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–µ–∫—Ç:
```bash
make run
```

